version: "2.1"

orbs:
  gcp-cli: circleci/gcp-cli@3.2.1
  node: circleci/node@5


parameters:
  project_id: 
    type: string
    default: GCP_PROJECT_ID
  workload_identity_pool_id: 
    type: string
    default: GCP_WIP_ID
  workload_identity_pool_provider_id: 
    type: string
    default: GCP_WIP_PROVIDER_ID
  service_account_email: 
    type: string
    default: GCP_SERVICE_ACCOUNT_EMAIL
  gcp_cred_config_file_path: 
    type: string
    default: /home/circleci/creds/gcp_cred_config.json
  oidc_token_file_path: 
    type: string
    default: /home/circleci/creds/oidc_token.json

steps:
      - &gcloud-auth
        name: Authorizing login using credentials generated by GCP
        command: |
          gcloud auth login --brief --cred-file "<< pipeline.parameters.gcp_cred_config_file_path >>"
      - &gcloud-env
        name: Changing the GOOGLE_APPLICATION_CREDENTIALS environment variable to use the generated credentials.
        command: |
          echo "export GOOGLE_APPLICATION_CREDENTIALS='<< pipeline.parameters.gcp_cred_config_file_path >>'" | tee -a $BASH_ENV        

    

jobs:
  gcp-oidc-defaults:
    executor: gcp-cli/default
    steps:
      - gcp-cli/install
      - run:
          name: Saving the OIDC token to the oidc token file  path
          command: |
            mkdir -p /home/circleci/creds
            echo $CIRCLE_OIDC_TOKEN > << pipeline.parameters.oidc_token_file_path >>
      - run:
          name: Generating the short term credential file
          command: |
            gcloud iam workload-identity-pools create-cred-config \
                "projects/${<< pipeline.parameters.project_id >>}/locations/global/workloadIdentityPools/${<< pipeline.parameters.workload_identity_pool_id >>}/providers/${<< pipeline.parameters.workload_identity_pool_provider_id >>}"\
                --output-file="<< pipeline.parameters.gcp_cred_config_file_path >>" \
                --service-account="${<< pipeline.parameters.service_account_email >>}" \
                --credential-source-file=<< pipeline.parameters.oidc_token_file_path >>
      - run:
          <<: *gcloud-auth
      - run:     
          <<: *gcloud-env
      - run:
          name: Set project
          command: |
              gcloud config set project elite-totality-418717
      - persist_to_workspace:
          root: /home/circleci/creds
          paths: 
            - gcp_cred_config.json
            - oidc_token.json
  test-node:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run tests
          command: npm test --passWithNoTests
  build:
    docker:
      - image: google/cloud-sdk

    steps:
      - checkout
      - attach_workspace:
          at: /home/circleci/creds
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          <<: *gcloud-auth
      - run:     
          <<: *gcloud-env
      - run:
          name: Set up Docker for gcloud
          command: |
            gcloud auth configure-docker us-central1-docker.pkg.dev
      - run:
          name: Docker build
          command: |
            docker build -t react-app .
      - run:
          name: Tag Docker image
          command: |
            docker tag react-app us-central1-docker.pkg.dev/elite-totality-418717/react-portfolio/portfolio-image
      - run:
          name: Push docker image
          command: | 
            docker push us-central1-docker.pkg.dev/elite-totality-418717/react-portfolio/portfolio-image
  deploy:
    docker:
      - image: google/cloud-sdk
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - attach_workspace:
          at: /home/circleci/creds
      - run:
          <<: *gcloud-auth
      - run:     
          <<: *gcloud-env
      - run:
          name: Update the container image for the instance
          command: |
            gcloud compute instances update-container virtual-machine --project=elite-totality-418717 --zone us-west4-b  --container-image=us-central1-docker.pkg.dev/elite-totality-418717/react-portfolio/portfolio-image:latest
  

workflows:
  main:
    jobs: 
      - gcp-oidc-defaults
      - test-node
      - build:
          requires:
            - gcp-oidc-defaults
      - release-approval:
          type: approval
          requires:
            - test-node
            - build
            - gcp-oidc-defaults
          filters:
             branches:
               only:
                 - main
      - deploy:
          requires:
            - test-node
            - build
            - release-approval
            - gcp-oidc-defaults
          filters:
             branches:
               only:
                 - main 